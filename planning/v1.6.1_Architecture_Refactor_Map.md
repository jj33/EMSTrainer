# v1.6.1 Architecture Refactor Mapping

**Date:** 2025-01-08
**Status:** Planning Phase
**Priority:** CRITICAL - Hotfix Required

---

## THE PROBLEM

v1.6.0 has a critical bug when loading all prompts together:
- Core.txt + Scenario_Mode.txt + Instructor_Prompt.txt = CHAOS
- Roles get confused (instructor/student mixed)
- AI tries to do everything simultaneously
- Modes bleed into each other

**Root Cause:** Scenario_Mode.txt contains shared data needed by BOTH students and instructors.

---

## THE SOLUTION

**New Architecture (v1.6.1):**

```
EMSTrainer_Core.txt
  └─ Foundation + ALL shared configuration
  └─ Used by EVERYONE

EMSTrainer_Student_Interface.txt
  └─ Student UI and workflows ONLY
  └─ Load: Core + Student_Interface

EMSTrainer_Instructor_Interface.txt  
  └─ Instructor UI and workflows ONLY
  └─ Load: Core + Instructor_Interface
```

**Key Principle:** Core contains ALL shared data. Interfaces are UI-only layers.

---

## CONTENT MAPPING

### PART 1: What Stays in Core.txt

**Keep (Already There):**
- Version information
- Model requirements
- Educational disclaimer
- Provider levels & scope
- Partner logic (shared rules)
- Timing standards
- Grading rubric (100 pts)
- Hash validation & integrity
- UI suppression policy
- Version compatibility
- Shared scenario file structure
- Cross-mode features
- Test Question Mode (complete)
- Study Guide Mode (complete)

**Move TO Core (from Scenario_Mode.txt):**
- Difficulty modes (Easy/Standard/Hard/Monica) - FULL DEFINITIONS
- Scene safety (continuous assessment) - COMPLETE RULES
- Vitals trending (dynamic patient response) - ALL LOGIC
- Dynamic equipment failures - PROBABILITY & TYPES
- Hidden grading criteria - COMPLETE SPECS
- Special events & curveballs - DEFINITIONS
- Partner interaction in timeline - FORMATTING
- Debrief format - TEMPLATE STRUCTURE
- Scenario start template - FORMAT
- Submission export format - STRUCTURE

**Rationale:** These are shared concepts both students AND instructors need to understand.

---

## PART 2: Student_Interface.txt (NEW FILE)

**Purpose:** Student-facing UI and workflows

**Content:**
```
=== STUDENT INTERFACE ===

You are EMSTrainer Student Assistant.

**Your Role:**
- Run scenarios for students
- Present test questions
- Generate study guides
- Provide immediate feedback
- Track progress

**Loading Requirements:**
- MUST load Core.txt first
- Load Student_Interface.txt second
- DO NOT load Instructor_Interface.txt

**Workflow: Scenario Mode**
1. Student loads/receives scenario JSON
2. Present scenario using template from Core
3. Accept student actions
4. Update vitals based on trending logic (from Core)
5. Apply difficulty mode rules (from Core)
6. Track timing against standards (from Core)
7. Generate debrief using format (from Core)
8. Export submission file

**Workflow: Test Mode**
[Use Test Question Mode from Core]

**Workflow: Study Mode**
[Use Study Guide Mode from Core]

**Student Commands:**
- "Load scenario [file]"
- "Start test on [topic]"
- "Create study guide for [topic]"
- "Show my progress"

**Narrative Style by Difficulty:**
[Reference difficulty modes from Core]

**Interaction Rules:**
- Be supportive and educational
- Provide hints in Easy mode
- Challenge appropriately in Hard/Monica
- Never break character during scenario
```

---

## PART 3: Instructor_Interface.txt (REFACTORED)

**Purpose:** Instructor-facing UI and workflows

**Content:**
```
=== INSTRUCTOR INTERFACE ===

You are EMSTrainer Instructor Assistant.

**Your Role:**
- Create scenarios
- Generate tests/study guides
- Deploy to students
- Grade submissions
- Generate class summaries

**Loading Requirements:**
- MUST load Core.txt first
- Load Instructor_Interface.txt second
- DO NOT load Student_Interface.txt

**Workflow: Scenario Creation**
1. Ask instructor for details
2. Use difficulty definitions from Core
3. Use scenario structure from Core
4. Generate JSON with proper hash
5. Provide deployment instructions

**Workflow: Test/Study Creation**
[Use Test/Study modes from Core]

**Workflow: Grading**
1. Validate submission hash
2. Apply grading rubric from Core
3. Check hidden criteria from Core
4. Generate feedback
5. Provide detailed report

**Instructor Commands:**
- "Create [type] scenario"
- "Generate test on [topic]"
- "Deploy to [students]"
- "Grade submission [file]"
- "Class summary"

**Creation Wizards:**
[Conversational flows for scenario creation]
```

---

## DETAILED CONTENT MOVES

### FROM: Scenario_Mode.txt → TO: Core.txt

**Section: DIFFICULTY MODES**
- Move complete definitions of Easy/Standard/Hard/Monica
- Keep ALL subsections intact
- This is CONFIGURATION, not UI

**Section: SCENE SAFETY**
- Move entire section
- Both students and instructors need to understand rules
- Configuration data, not UI

**Section: VITALS TRENDING**
- Move complete trending logic
- All difficulty-specific rules
- Examples included

**Section: EQUIPMENT FAILURES**
- Move probability tables
- Failure types
- Timing rules

**Section: HIDDEN GRADING CRITERIA**
- Move Medication Safety (5 Rights)
- Move AIDET
- Move Scene Safety Reassessment
- These are grading RULES (configuration)

**Section: SPECIAL EVENTS & CURVEBALLS**
- Move definitions and types
- Keep examples
- Configuration, not UI

**Section: DEBRIEF FORMAT**
- Move template structure
- Both students (viewing) and instructors (creating) need it
- Keep Markdown structure

**Section: SCENARIO START TEMPLATE**
- Move to Core
- Standard format for all scenarios

**Section: SUBMISSION EXPORT**
- Move format definition
- Students need to generate, instructors need to read

---

### FROM: Scenario_Mode.txt → DELETE/REFACTOR

**Section: PREREQUISITES**
- Delete (no longer needed with new architecture)

**Section: PURPOSE**
- Refactor into Student_Interface introduction

**Section: PARTNER INTERACTION IN TIMELINE**
- Move format to Core
- UI behavior stays in Student_Interface

---

### FROM: Instructor_Prompt.txt → KEEP/REFACTOR

**Keep in Instructor_Interface:**
- Version information (specific to instructor)
- Loading instructions (updated for new arch)
- Instructor workflows (CREATE, DEPLOY, GRADE)
- Example interactions
- Conversational style
- Quick reference commands

**Move to Core:**
- Nothing - instructor prompt already correctly separated

---

## FILE SIZE ESTIMATES

**Current:**
- Core.txt: ~800 lines
- Scenario_Mode.txt: ~1100 lines
- Instructor_Prompt.txt: ~800 lines

**After Refactor:**
- Core.txt: ~1600 lines (doubles, becomes comprehensive)
- Student_Interface.txt: ~400 lines (new, UI only)
- Instructor_Interface.txt: ~600 lines (reduced, UI only)

---

## IMPLEMENTATION CHECKLIST

- [ ] Create backup of existing prompts
- [ ] Create new Core.txt with moved content
- [ ] Create new Student_Interface.txt
- [ ] Create new Instructor_Interface.txt
- [ ] Update all loading instructions
- [ ] Update documentation
- [ ] Test: Student loads Core + Student only
- [ ] Test: Instructor loads Core + Instructor only
- [ ] Test: Verify NO role confusion
- [ ] Update CHANGELOG
- [ ] Update version to v1.6.1
- [ ] Release hotfix

---

## TESTING PLAN

**Test Case 1: Student Scenario**
- Load: Core.txt + Student_Interface.txt
- Run: Cardiac arrest scenario
- Verify: No instructor features appear
- Verify: Proper difficulty mode behavior
- Verify: Clean debrief generation

**Test Case 2: Instructor Creation**
- Load: Core.txt + Instructor_Interface.txt
- Create: New trauma scenario
- Verify: No student mode features
- Verify: Proper scenario JSON generated
- Verify: Clean deployment format

**Test Case 3: Role Isolation**
- Load: Core.txt + Student_Interface.txt
- Attempt: "Create a scenario"
- Expected: "That's an instructor function"
- Verify: Clean rejection

**Test Case 4: Monica Mode**
- Load: Core.txt + Student_Interface.txt
- Run: Monica difficulty scenario
- Verify: All Monica features active
- Verify: Proper chaos and challenge level

---

## MIGRATION NOTES

**For Users:**
- Old prompts (v1.6.0) will STOP WORKING
- Must download new v1.6.1 prompts
- Loading instructions completely changed
- Same functionality, better architecture

**For Documentation:**
- Update all Quick Start Guides
- Update Reference Guides
- Update README loading instructions
- Create migration guide for v1.6.0 → v1.6.1

---

## VERSION HISTORY

**v1.6.0 (Oct 2025):**
- Architecture bug: All prompts loadable together
- Results: Role confusion and chaos

**v1.6.1 (Jan 2025 - HOTFIX):**
- Fixed architecture: Clear separation
- Core = shared config
- Student_Interface = student UI only
- Instructor_Interface = instructor UI only
- NEVER load both interfaces

---

**Next Step:** Execute the refactor based on this map.
